name: BMS Advance Tracker (Shards + Combiner | SAFE)

on:
  workflow_dispatch:
  schedule:
    # IST window mapped in UTC (every hour)
    - cron: "0 21-23,0-17 * * *"

permissions:
  contents: write

env:
  PYTHONUNBUFFERED: 1

jobs:
# =====================================================
# 1ï¸âƒ£ DECIDE DATE (FREEZE ONCE)
# =====================================================
  decide-day:
    name: Decide DATE_CODE
    runs-on: ubuntu-latest
    outputs:
      date_code: ${{ steps.set.outputs.date_code }}

    steps:
      - id: set
        run: |
          DATE_CODE=$(date -u -d '+1 day' +%Y%m%d)
          echo "date_code=$DATE_CODE" >> $GITHUB_OUTPUT
          echo "ğŸ“… DATE_CODE = $DATE_CODE"

# =====================================================
# 2ï¸âƒ£ SHARD RUNNERS (PARALLEL)
# =====================================================
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    needs: decide-day
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1,2,3,4,5,6,7,8,9]

    env:
      SHARD_ID: ${{ matrix.shard }}
      DATE_CODE: ${{ needs.decide-day.outputs.date_code }}

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install deps
        run: |
          pip install --upgrade pip
          pip install cloudscraper pytz aiohttp

      - name: ğŸš€ Run shard ${{ matrix.shard }}
        run: |
          python bmsrotate${{ matrix.shard }}.py

      # ğŸ” PUSH SHARD OUTPUT (REBASE SAFE)
      - name: â¬†ï¸ Push shard data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add advance/data/${DATE_CODE}
          git commit -m "Shard $SHARD_ID data (${DATE_CODE})" || echo "Nothing to commit"

          git fetch origin
          git pull --rebase origin main
          git push origin main

# =====================================================
# 3ï¸âƒ£ COMBINER (AFTER ALL SHARDS)
# =====================================================
  combiner:
    name: Combine shards
    runs-on: ubuntu-latest
    needs: [decide-day, shards]
    timeout-minutes: 20

    env:
      DATE_CODE: ${{ needs.decide-day.outputs.date_code }}

    steps:
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ”¥ğŸ”¥ğŸ”¥ CRITICAL FIX ğŸ”¥ğŸ”¥ğŸ”¥
      - name: ğŸ”„ Sync with latest main (REQUIRED)
        run: |
          git fetch origin
          git reset --hard origin/main
          git status

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install deps
        run: |
          pip install pytz

      - name: ğŸ“‚ Verify shard files
        run: |
          echo "ğŸ“ advance/data/${DATE_CODE}"
          ls -lh advance/data/${DATE_CODE} || true

      - name: ğŸ§© Run combiner
        run: |
          python combine_shards_rotate.py

      # ğŸ” PUSH FINAL OUTPUT
      - name: â¬†ï¸ Push final combined data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add advance/data/${DATE_CODE}/finaldetailed.json
          git add advance/data/${DATE_CODE}/finalsummary.json
          git commit -m "Final combined BMS data (${DATE_CODE})" || echo "Nothing to commit"

          git fetch origin
          git pull --rebase origin main
          git push origin main
