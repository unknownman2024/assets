name: BMS DailyBO 1â€“9 + Combine

on:
  workflow_dispatch:
  schedule:
    # Every hour (UTC) â†’ IST handled inside code
    - cron: "0 * * * *"

permissions:
  contents: write

jobs:
  shards:
    name: Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9]

    steps:
      # ---------------- CHECKOUT ----------------
      - name: ğŸ§¾ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------- PYTHON ----------------
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------- DEPENDENCIES ----------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager cloudscraper aiohttp pytz

      # ---------------- RUN SHARD ----------------
      - name: ğŸš€ Run shard scraper
        run: |
          python bmsdaily${{ matrix.shard }}.py

      # ---------------- SAFE SHARD COMMIT ----------------
      - name: ğŸ’¾ Commit shard to isolated branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          BRANCH="shard-${{ matrix.shard }}"

          # create/reset shard branch
          git checkout -B $BRANCH

          git add daily/
          git status

          if git diff --cached --quiet; then
            echo "No changes for shard $BRANCH"
            exit 0
          fi

          git commit -m "Shard ${{ matrix.shard }} update ($(date +'%Y-%m-%d %H:%M'))"

          # force is SAFE here because each shard owns its own branch
          git push origin $BRANCH --force

  combine:
    name: Combine all shards
    needs: shards
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ---------------- CHECKOUT ----------------
      - name: ğŸ§¾ Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------- PYTHON ----------------
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------- FETCH SHARDS ----------------
      - name: ğŸ”„ Fetch shard branches
        run: |
          git fetch origin
          for i in 1 2 3 4 5 6 7 8 9; do
            git show-ref --verify --quiet refs/remotes/origin/shard-$i && echo "Found shard-$i" || echo "Missing shard-$i"
          done

      # ---------------- COMBINE ----------------
      - name: ğŸ”— Combine shard JSONs
        run: |
          pip install pytz
          python combine_dailyshards.py

      # ---------------- FINAL COMMIT ----------------
      - name: ğŸ’¾ Commit & push final combined data (FORCE SAFE)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Always sync exactly with origin/main
          git fetch origin
          git reset --hard origin/main

          # Apply freshly combined output
          git add daily/
          git status

          if git diff --cached --quiet; then
            echo "No combined changes"
            exit 0
          fi

          git commit -m "Final combined BMS data ($(date +'%Y-%m-%d %H:%M'))"

          # Final output is source of truth â†’ force push
          git push origin main --force
